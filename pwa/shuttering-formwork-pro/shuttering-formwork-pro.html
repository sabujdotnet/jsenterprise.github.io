<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shuttering/Formwork Pro — Invoice & Rental Tool</title>
  <!-- Icons, PDF, QR, Language, CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="manifest" href="manifest.json"><!-- for PWA -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c;
      --success: #2ecc71; --bg: #f5f6fa; --card: #fff;
    }
    body { background: linear-gradient(180deg, #560c8e, #2b0b3a); color: #222; padding: 0; margin: 0;}
    .container { max-width: 1280px; margin: 0 auto; padding: 20px;}
    header { background: linear-gradient(135deg,var(--primary),var(--secondary)); color: #fff; padding: 20px; border-radius: 8px;}
    .flex { display: flex; gap: 16px; align-items: center;}
    .right { margin-left: auto;}
    .lang-switch { border: none; background: none; color: #fff; font-size: 1.1em; cursor: pointer;}
    .app-grid { display: grid; grid-template-columns: 1fr 480px; gap: 28px; margin-top: 24px;}
    @media (max-width: 1100px) { .app-grid { grid-template-columns: 1fr; } }
    .card { background: var(--card); border-radius: 10px; box-shadow: 0 8px 24px #0001; padding: 20px; margin-bottom: 18px;}
    h2, h3 { margin: 0 0 10px 0;}
    .form-group { margin-bottom: 14px; }
    label { font-weight: 600; margin-bottom: 4px; display: block;}
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #bbb; border-radius: 6px; font-size: 1em;}
    .flex-row { display: flex; gap: 10px; }
    .ftin-row { display: flex; gap: 6px; align-items: center; }
    .ftin-row input[type=number] { width: 50px; }
    button { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;}
    .btn-primary { background: var(--secondary); color: #fff;}
    .btn-danger { background: var(--accent); color: #fff;}
    .btn-success { background: var(--success); color: #fff;}
    .btn-gray { background: #eee;}
    .btn:disabled { opacity: .6; cursor: not-allowed;}
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.98em;}
    th, td { border: 1px solid #ddd; padding: 7px; text-align: left;}
    th { background: #f2f8fa;}
    .summary-row { display: flex; justify-content: space-between; margin-top: 8px;}
    .summary-row.total { font-weight: bold; border-top: 2px solid var(--primary);}
    .logo-preview { max-width: 110px; max-height: 70px; margin-bottom: 5px;}
    .qr { margin-top: 10px;}
    .no-print { display: block;}
    @media print {
      body { background: #fff; color: #000; }
      .no-print, header, footer { display: none !important; }
      .app-grid { grid-template-columns: 1fr; }
      .bill-preview { box-shadow: none; border: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container flex">
      <div class="flex">
        <i class="fas fa-hard-hat" style="font-size:2.2em"></i>
        <div>
          <h2 id="appTitle">Shuttering/Formwork Pro</h2>
          <small id="appDesc">All-in-one Invoice & Rental Management Tool</small>
        </div>
      </div>
      <button class="lang-switch right" onclick="setLang('en')">EN</button>
      <button class="lang-switch" onclick="setLang('bn')">BN</button>
      <button class="lang-switch" onclick="setLang('hi')">HI</button>
      <button class="btn-primary right" onclick="showLogin()" id="loginBtn">Login</button>
      <button class="btn-danger right" onclick="logout()" id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </header>
  <main class="container app-grid">
    <div>
      <!-- Company Info & Logo -->
      <div class="card">
        <h3><i class="fas fa-building"></i> Business Settings</h3>
        <div class="form-group">
          <label>Company Name</label>
          <input id="companyName" value="J/s Enterprise">
        </div>
        <div class="form-group">
          <label>Company Address</label>
          <input id="companyAddress" value="Narayanganj, Bangladesh">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input id="companyPhone" value="01994316210">
        </div>
        <div class="form-group">
          <label>GSTIN</label>
          <input id="companyGST" value="27ABCDE1234F1Z2">
        </div>
        <div class="form-group">
          <label>Logo</label>
          <input type="file" id="logoUpload" accept="image/*">
          <img id="logoPreview" class="logo-preview" />
        </div>
        <div class="form-group flex-row">
          <label>Currency</label>
          <select id="currency">
            <option value="৳">৳ BDT</option>
            <option value="₹">₹ INR</option>
            <option value="$">$ USD</option>
            <option value="€">€ EUR</option>
          </select>
          <label class="right">Tax Rate (%)</label>
          <input id="taxRate" type="number" value="18" min="0" style="width:70px;">
        </div>
      </div>
      <!-- Customer Info -->
      <div class="card">
        <h3><i class="fas fa-user"></i> Customer Info</h3>
        <div class="form-group"><label>Name</label><input id="customerName" type="text"></div>
        <div class="form-group"><label>Address</label><textarea id="customerAddress" rows="2"></textarea></div>
        <div class="form-group"><label>Phone</label><input id="customerPhone" type="text"></div>
        <div class="form-group"><label>GSTIN</label><input id="customerGST" type="text"></div>
      </div>
      <!-- Rental Items -->
      <div class="card">
        <h3><i class="fas fa-cube"></i> Rental Items</h3>
        <div class="form-group flex-row">
          <label>Category</label>
          <select id="itemCategory">
            <option value="Slab">Slab</option>
            <option value="Beam">Beam</option>
            <option value="Column">Column</option>
            <option value="Wall">Wall</option>
            <option value="Staircase">Staircase</option>
            <option value="Round Column">Round Column</option>
            <option value="Other">Other</option>
          </select>
          <label>Available</label>
          <input id="itemInventory" type="number" min="0" value="100" style="width:70px;">
        </div>
        <div class="form-group"><label>Description</label><input id="itemDescription" type="text"></div>
        <div class="form-group flex-row">
          <label>Area (sqft)</label>
          <input id="itemSqft" type="number" step="any" placeholder="Area" style="flex:1;">
        </div>
        <div class="form-group flex-row">
          <label>OR, Enter (ft x inch):</label>
          <div class="ftin-row">
            <input id="itemFt" type="number" min="0" placeholder="ft">
            <span>ft</span>
            <input id="itemIn" type="number" min="0" max="11.99" step="any" placeholder="in">
            <span>in</span>
            <span>×</span>
            <input id="itemFt2" type="number" min="0" placeholder="ft">
            <span>ft</span>
            <input id="itemIn2" type="number" min="0" max="11.99" step="any" placeholder="in">
            <span>in</span>
            <button type="button" class="btn-gray" onclick="calcSqftFromFtIn()">=</button>
            <span id="ftinResult" style="min-width:70px;display:inline-block;"></span>
          </div>
        </div>
        <div class="form-group flex-row">
          <label>Rate</label><input id="itemRate" type="number">
        </div>
        <div class="form-group flex-row">
          <label>Discount</label><input id="itemDiscount" type="number" min="0" value="0" style="width:60px;">%
          <label>Notes</label><input id="itemNote" type="text">
        </div>
        <div class="form-group flex-row">
          <button id="addItem" class="btn-primary">Add Item</button>
          <button id="clearItems" class="btn-danger">Clear Items</button>
        </div>
        <h4>Items List</h4>
        <table id="itemsTable"><thead><tr>
          <th>Category</th><th>Description</th><th>Area</th><th>Rate</th><th>Discount</th><th>Amount</th><th>Note</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <!-- Invoice Notes, Charges, Discount -->
      <div class="card">
        <h3><i class="fas fa-file-alt"></i> Invoice Details</h3>
        <div class="form-group"><label>Additional Charges</label><input id="addCharges" type="number" value="0"></div>
        <div class="form-group"><label>Total Discount (%)</label><input id="totalDiscount" type="number" value="0"></div>
        <div class="form-group"><label>Notes</label><textarea id="invoiceNote"></textarea></div>
      </div>
      <!-- Data/Analytics/Export -->
      <div class="card no-print">
        <h3><i class="fas fa-database"></i> Data & Dashboard</h3>
        <button onclick="showDashboard()" class="btn-success">My Invoices</button>
        <button onclick="exportCSV()" class="btn-gray">Export CSV</button>
        <button onclick="exportExcel()" class="btn-gray">Export Excel</button>
        <div id="analyticsBoard" style="margin-top:10px"></div>
      </div>
    </div>
    <!-- RIGHT: Invoice Preview -->
    <aside>
      <div class="bill-preview card" id="billPreview">
        <div class="flex-row" style="align-items:center;justify-content:space-between;">
          <div>
            <img id="previewLogo" class="logo-preview" style="display:inline;">
            <h2 style="margin:8px 0 0 0" id="previewCompanyName"></h2>
            <small id="previewCompanyAddress"></small>
            <div id="previewCompanyPhone"></div>
            <div id="previewCompanyGST"></div>
          </div>
          <div class="qr" id="qrCode"></div>
        </div>
        <div style="margin:10px 0;">
          <b>Invoice #: </b><span id="invoiceNumber"></span><br>
          <b>Date: </b><span id="invoiceDate"></span>
        </div>
        <hr>
        <div>
          <b>Bill To:</b>
          <div id="previewCustomerName"></div>
          <div id="previewCustomerAddress"></div>
          <div id="previewCustomerPhone"></div>
          <div id="previewCustomerGST"></div>
        </div>
        <table>
          <thead><tr>
            <th>Cat.</th><th>Description</th><th>Area</th><th>Rate</th><th>Disc.</th><th>Amount</th><th>Note</th>
          </tr></thead>
          <tbody id="previewItems"></tbody>
        </table>
        <div class="summary-row"><span>Subtotal</span><span id="previewSubtotal"></span></div>
        <div class="summary-row"><span>Additional Charges</span><span id="previewAddCharges"></span></div>
        <div class="summary-row"><span>Discount</span><span id="previewDiscount"></span></div>
        <div class="summary-row"><span>Tax</span><span id="previewTax"></span></div>
        <div class="summary-row total"><span>Total</span><span id="previewTotal"></span></div>
        <div><b>Notes:</b> <span id="previewInvoiceNote"></span></div>
        <div style="margin-top: 10px; text-align:center; color:#555">Thank you for your business!</div>
        <div class="no-print flex-row" style="margin-top:10px;gap:8px;">
          <button onclick="printInvoice()" class="btn-primary">Print</button>
          <button onclick="downloadPDF()" class="btn-success">PDF</button>
          <button onclick="sendEmail()" class="btn-gray">Send Email</button>
          <button onclick="resetForm()" class="btn-danger">Reset</button>
        </div>
      </div>
    </aside>
  </main>
  <footer style="text-align:center; color:#ddd; margin-bottom:10px;">© 2025 Powered by Sabuj</footer>
  <!-- PWA Install Banner etc. can go here -->
  <!-- Language, Auth, Analytics, IndexedDB, Email, PDF, QRCode scripts... -->
  <script>
    // ==== STATE ====
    let items = [];
    let invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
    let logoData = localStorage.getItem("companyLogo") || "";
    let user = null; // currentUser

    // ==== UTILS ====
    function $(id) { return document.getElementById(id); }
    function currency() { return $("currency").value; }
    function taxRate() { return parseFloat($("taxRate").value) || 0; }
    function previewCurrency(val) { return currency() + (parseFloat(val)||0).toFixed(2); }
    function genInvoiceNum() { return "INV-" + new Date().getFullYear() + "-" + Math.floor(Math.random()*99999); }

    // ==== FT-INCH AREA CALC ====
    function calcSqftFromFtIn() {
      // Get the values for both dimensions (ft + in)
      let ft1 = parseFloat($("itemFt").value)||0;
      let in1 = parseFloat($("itemIn").value)||0;
      let ft2 = parseFloat($("itemFt2").value)||0;
      let in2 = parseFloat($("itemIn2").value)||0;
      // Convert to feet
      let dim1 = ft1 + in1/12;
      let dim2 = ft2 + in2/12;
      let area = dim1 * dim2;
      $("ftinResult").textContent = area>0 ? area.toFixed(3)+" sqft" : "";
      if(area>0){
        $("itemSqft").value = area.toFixed(3);
      }
      return area;
    }
    // Allow pressing enter in ft/in fields to recalc
    ["itemFt","itemIn","itemFt2","itemIn2"].forEach(id=>{
      $(id).addEventListener("input", calcSqftFromFtIn);
    });

    // ==== COMPANY SETTINGS ====
    function updateCompanyPreview() {
      $("previewCompanyName").textContent = $("companyName").value;
      $("previewCompanyAddress").textContent = $("companyAddress").value;
      $("previewCompanyPhone").textContent = $("companyPhone").value;
      $("previewCompanyGST").textContent = $("companyGST").value;
      $("previewLogo").src = logoData;
      $("previewLogo").style.display = logoData ? "block" : "none";
      localStorage.setItem("companyName", $("companyName").value);
      localStorage.setItem("companyAddress", $("companyAddress").value);
      localStorage.setItem("companyPhone", $("companyPhone").value);
      localStorage.setItem("companyGST", $("companyGST").value);
      localStorage.setItem("companyLogo", logoData);
    }
    ["companyName","companyAddress","companyPhone","companyGST"].forEach(id => $(id).addEventListener("input", updateCompanyPreview));
    $("logoUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) { logoData = ev.target.result; updateCompanyPreview(); }
      reader.readAsDataURL(file);
    });
    $("currency").addEventListener("change", updateAll);
    $("taxRate").addEventListener("input", updateAll);

    // ==== INVOICE DETAILS ====
    function updateCustomerPreview() {
      ["customerName","customerAddress","customerPhone","customerGST"].forEach(id => {
        $("preview" + id.charAt(0).toUpperCase() + id.slice(1)).textContent = $(id).value;
      });
    }
    ["customerName","customerAddress","customerPhone","customerGST"].forEach(id => $(id).addEventListener("input", updateCustomerPreview));

    // ==== RENTAL ITEMS ====
    function renderItemsTable() {
      let tbody = $("itemsTable").querySelector("tbody");
      tbody.innerHTML = "";
      items.forEach((it, i) => {
        tbody.innerHTML += `<tr>
          <td>${it.cat}</td>
          <td>${it.desc}</td>
          <td>${it.area}</td>
          <td>${previewCurrency(it.rate)}</td>
          <td>${it.discount}%</td>
          <td>${previewCurrency(it.amount)}</td>
          <td>${it.note||""}</td>
          <td><button onclick="removeItem(${i})" class="btn-danger">x</button></td>
        </tr>`;
      });
    }
    function renderInvoicePreview() {
      let pbody = $("previewItems"); pbody.innerHTML = "";
      let subtotal = 0;
      items.forEach(it => {
        pbody.innerHTML += `<tr>
          <td>${it.cat}</td>
          <td>${it.desc}</td>
          <td>${it.area}</td>
          <td>${previewCurrency(it.rate)}</td>
          <td>${it.discount}%</td>
          <td>${previewCurrency(it.amount)}</td>
          <td>${it.note||""}</td>
        </tr>`;
        subtotal += it.amount;
      });
      $("previewSubtotal").textContent = previewCurrency(subtotal);
      let addCharges = parseFloat($("addCharges").value)||0;
      let totalDiscount = parseFloat($("totalDiscount").value)||0;
      let discountAmt = subtotal * totalDiscount/100;
      $("previewAddCharges").textContent = previewCurrency(addCharges);
      $("previewDiscount").textContent = previewCurrency(discountAmt);
      let taxed = Math.max(0, subtotal + addCharges - discountAmt);
      let tax = taxed * taxRate()/100;
      $("previewTax").textContent = previewCurrency(tax);
      let total = taxed + tax;
      $("previewTotal").textContent = previewCurrency(total);
      $("previewInvoiceNote").textContent = $("invoiceNote").value;
      // QR code
      $("qrCode").innerHTML = "";
      new QRCode($("qrCode"), { text: $("invoiceNumber").textContent, width:64, height:64 });
      updateCompanyPreview();
      updateCustomerPreview();
    }
    function updateAll() { renderItemsTable(); renderInvoicePreview(); }
    function addItem() {
      let cat = $("itemCategory").value,
          desc = $("itemDescription").value,
          area = parseFloat($("itemSqft").value) || 0,
          rate = parseFloat($("itemRate").value) || 0,
          discount = parseFloat($("itemDiscount").value)||0,
          note = $("itemNote").value;
      if (!desc || area <= 0 || rate <= 0) return alert("Fill all item fields");
      let amount = area * rate * (1 - discount/100);
      items.push({ cat, desc, area, rate, discount, note, amount });
      $("itemDescription").value = $("itemSqft").value = $("itemRate").value = $("itemDiscount").value = $("itemNote").value = "";
      // Also clear ft/in fields and ftinResult
      ["itemFt","itemIn","itemFt2","itemIn2"].forEach(id => $(id).value = "");
      $("ftinResult").textContent = "";
      updateAll();
    }
    function removeItem(i) { items.splice(i,1); updateAll(); }
    $("addItem").onclick = addItem;
    $("clearItems").onclick = () => { if(confirm("Clear items?")){ items=[]; updateAll(); }};
    ["addCharges","totalDiscount","invoiceNote"].forEach(id => $(id).addEventListener("input", renderInvoicePreview));

    // ==== INVOICE NUMBER, DATE, LOGO ====
    function setupInvoice() {
      $("invoiceDate").textContent = new Date().toLocaleDateString();
      $("invoiceNumber").textContent = genInvoiceNum();
      logoData = localStorage.getItem("companyLogo") || "";
      $("previewLogo").src = logoData;
      $("previewLogo").style.display = logoData ? "block":"none";
      $("companyName").value = localStorage.getItem("companyName") || "J/s Enterprise";
      $("companyAddress").value = localStorage.getItem("companyAddress") || "Narayanganj, Bangladesh";
      $("companyPhone").value = localStorage.getItem("companyPhone") || "01994316210";
      $("companyGST").value = localStorage.getItem("companyGST") || "27ABCDE1234F1Z2";
      updateCompanyPreview();
      renderInvoicePreview();
    }
    setupInvoice();

    // ==== PDF Export ====
    function downloadPDF() {
      html2pdf().set({ filename: $("invoiceNumber").textContent + ".pdf" })
        .from($("billPreview")).save();
    }

    // ==== CSV/Excel Export ====
    function exportCSV() {
      let csv = "Category,Description,Area,Rate,Discount,Amount,Note\n" +
        items.map(it => `${it.cat},${it.desc},${it.area},${it.rate},${it.discount},${it.amount},${it.note||""}`).join("\n");
      let blob = new Blob([csv], {type:"text/csv"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = "items.csv"; a.click();
    }
    function exportExcel() {
      alert("Excel export: Please use CSV export and open in Excel (or integrate SheetJS)");
    }

    // ==== Email Invoice (stub, ready for integration) ====
    function sendEmail() {
      let email = prompt("Enter recipient email:");
      if(!email) return;
      alert("Email sent to " + email + " (Feature: connect to EmailJS or backend API for real email sending.)");
    }

    // ==== LocalStorage Data Persistence ====
    function saveInvoice() {
      let invoice = {
        number: $("invoiceNumber").textContent,
        date: $("invoiceDate").textContent,
        customer: {
          name: $("customerName").value, address: $("customerAddress").value,
          phone: $("customerPhone").value, gst: $("customerGST").value
        },
        items: JSON.parse(JSON.stringify(items)),
        charges: $("addCharges").value, discount: $("totalDiscount").value,
        note: $("invoiceNote").value, total: $("previewTotal").textContent
      };
      invoices.push(invoice);
      localStorage.setItem("invoices", JSON.stringify(invoices));
      alert("Invoice saved!");
    }
    // ==== Dashboard ====
    function showDashboard() {
      let dash = invoices.slice(-20).reverse().map(inv => `
        <div style="border-bottom:1px solid #ddd;padding:5px;">
          <b>${inv.number}</b> — ${inv.date}<br>
          <span>${inv.customer.name}</span> | <span>${inv.total}</span>
        </div>`).join("");
      $("analyticsBoard").innerHTML = `<h4>Recent Invoices</h4>${dash || "No invoices yet."}`;
    }

    // ==== Reset Form ====
    function resetForm() {
      if(!confirm("Reset all fields?")) return;
      ["customerName","customerAddress","customerPhone","customerGST","itemDescription","itemSqft","itemRate","itemDiscount","itemNote","addCharges","totalDiscount","invoiceNote"].forEach(id=>{
        if($(id).type=="number"||$(id).type=="text") $(id).value = "";
        else $(id).value = "";
      });
      // Also clear ft/in fields and ftinResult
      ["itemFt","itemIn","itemFt2","itemIn2"].forEach(id => $(id).value = "");
      $("ftinResult").textContent = "";
      items = [];
      setupInvoice();
      updateAll();
    }

    // ==== Print ====
    function printInvoice() {
      window.print();
    }

    // ==== Language Switch ====
    function setLang(lang) {
      alert("Language change: " + lang + " (Stub. For real i18n, integrate i18next or similar, and provide UI translations)");
    }

    // ==== Auth (stub) ====
    function showLogin() {
      let name = prompt("Enter username:");
      if(name) { user = name; $("loginBtn").style.display="none"; $("logoutBtn").style.display="inline-block"; alert("Logged in as "+name);}
    }
    function logout() {
      user = null; $("loginBtn").style.display="inline-block"; $("logoutBtn").style.display="none";
      alert("Logged out.");
    }

    // ==== Analytics (stub) ====
    // For real analytics, integrate with Chart.js and aggregate invoices.

    // ==== INSTALL PWA (stub) ====
    // For full PWA, add manifest.json, service worker, and prompt install.

    // ==== On Load: Update all ====
    updateAll();
  </script>
</body>
</html>
